#!/usr/bin/env Rscript

library(optparse)

option_list <- c(make_option('--input', type='character', default='dipp-rf-uniq.RData'),
                 make_option('--output', type='character', default='Rplots.pdf')
                )

parser <- OptionParser(option_list = option_list)
options <- parse_args(parser)

library(phyloseq)
library(ggplot2)
library(plyr)

source('lib/ggplot_theme.R')

load(options$input)

ss <- subset_taxa(dipp, Species == 'dorei-vulgatus')

glom <- tax_glom(ss, taxrank='Species')


meta <- data.frame(sample_data(glom))
otus <- data.frame(otu_table(glom))

meta$dorei <- otus[,1]


ggplot(meta,
       aes(x=age_at_sampling,
           y=dorei,
           color=seroconverted)) +
geom_point() +
geom_smooth() +
facet_wrap(seroconverted~dipp_person) +
coord_cartesian(ylim=c(0, 1), xlim=c(100,600)) +
opts(strip.background = theme_blank(),
     strip.text.x = theme_blank()) +
ggplot.theme


meta$bf <- meta$age_at_sampling - (meta$breast_feeding_duration*30)

ftp <- ddply(meta, ~dipp_person, function(x) x[with(x, order(age_at_sampling))[1],])


ggplot(ftp,
       aes(x=breast_feeding_duration,
           color=dorei > 0.3)) +
geom_density()

ggplot(ftp,
       aes(x=breast_feeding_duration,
           y=dorei)) +
geom_point() +
ggtitle(cor(ftp$breast_feeding_duration, ftp$dorei, use='complete.obs'))

m <- lm(breast_feeding_duration ~ dorei, data=ftp)

anova(m, test='Chisq')

max_dorei <- ddply(meta, ~dipp_person, function(x) x[with(x, order(-dorei))[1],])

ggplot(max_dorei,
       aes(x=dorei,
           color=seroconverted)) +
geom_density()

ggplot(max_dorei,
       aes(x=breast_feeding_duration,
           y=dorei)) +
geom_point()


avg_dorei <- ddply(meta, ~dipp_person, function(x) { x[1,]$dorei <- median(x$dorei); x })
avg_dorei <- ddply(avg_dorei, ~dipp_person, function(x) x[with(x, order(age_at_sampling))[1],])

ggplot(avg_dorei,
       aes(x=breast_feeding_duration,
           y=dorei)) +
geom_point()
